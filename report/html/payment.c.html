
<html>
<head>
<title>payment.c</title>
<link rel="stylesheet" type="text/css" href="./viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 #include &lt;stdio.h&gt;</div><div id="2" class="line none">    2 #include &lt;stdlib.h&gt;</div><div id="3" class="line none">    3 #include &lt;string.h&gt;</div><div id="4" class="line none">    4 #include &lt;assert.h&gt;</div><div id="5" class="line none">    5 #include "../include/constants.h"</div><div id="6" class="line none">    6 #include "../include/types.h"</div><div id="7" class="line none">    7 #include "../include/getters.h"</div><div id="8" class="line none">    8 </div><div id="9" class="line none">    9 Transaction <a href="payment.c.html#9">convertToTransaction</a>(const PayParameters* payParams) {</div><div id="10" class="line hit">   10     Transaction transaction;</div><div id="11" class="line hit">   11     transaction.source = payParams-&gt;payer;</div><div id="12" class="line hit">   12     transaction.destination = payParams-&gt;receiver;</div><div id="13" class="line hit">   13     transaction.amount = payParams-&gt;amount;</div><div id="14" class="line hit">   14     transaction.currency = payParams-&gt;currency;</div><div id="15" class="line hit">   15     return transaction;</div><div id="16" class="line hit">   16 }</div><div id="17" class="line none">   17 </div><div id="18" class="line none">   18 int <a href="payment.c.html#18">makePayment</a>(ContractState* state, const Transaction* candidateTransaction) {</div><div id="19" class="line none">   19     // Retrieve the source and destination parties</div><div id="20" class="line hit">   20     Party* sourceParty = candidateTransaction-&gt;source;</div><div id="21" class="line hit">   21     Party* destinationParty = candidateTransaction-&gt;destination;</div><div id="22" class="line none">   22 </div><div id="23" class="line none">   23     // Check if the source and destination parties exist</div><div id="24" class="line hit">   24     if (sourceParty == NULL || destinationParty == NULL) {</div><div id="25" class="line missed">   25         printf("Invalid transaction! Source or destination party not found.\n");</div><div id="26" class="line missed">   26         return 1;</div><div id="27" class="line none">   27     }</div><div id="28" class="line none">   28 </div><div id="29" class="line none">   29     // Retrieve the source internal account</div><div id="30" class="line hit">   30     InternalAccount* sourceAccount = NULL;</div><div id="31" class="line hit">   31     for (int i = 0; i &lt; state-&gt;internalWallet.numAccounts; i++) {</div><div id="32" class="line hit">   32         if (state-&gt;internalWallet.accounts[i].id == sourceParty-&gt;id) {</div><div id="33" class="line hit">   33             sourceAccount = &amp;(state-&gt;internalWallet.accounts[i]);</div><div id="34" class="line none">   34         }</div><div id="35" class="line hit">   35     }</div><div id="36" class="line none">   36 </div><div id="37" class="line none">   37     // Check if the source internal account exists</div><div id="38" class="line hit">   38     if (sourceAccount == NULL) {</div><div id="39" class="line missed">   39         printf("Invalid transaction! Source internal account not found.\n");</div><div id="40" class="line missed">   40         return 1;</div><div id="41" class="line none">   41     }</div><div id="42" class="line none">   42 </div><div id="43" class="line none">   43     // Check if there are enough funds in the source internal account</div><div id="44" class="line hit">   44     int sourceBalance = 0;</div><div id="45" class="line hit">   45     for (int i = 0; i &lt; NUMTOKENS; i++) {</div><div id="46" class="line hit">   46         if (sourceAccount-&gt;wallet.tokens[i].currency == candidateTransaction-&gt;currency) {</div><div id="47" class="line hit">   47             sourceBalance = sourceAccount-&gt;wallet.tokens[i].amount;</div><div id="48" class="line none">   48         }</div><div id="49" class="line hit">   49     }</div><div id="50" class="line none">   50 </div><div id="51" class="line hit">   51     if (sourceBalance &lt; candidateTransaction-&gt;amount) {</div><div id="52" class="line missed">   52         printf("Insufficient funds in the source internal account.\n");</div><div id="53" class="line missed">   53         return 1;</div><div id="54" class="line none">   54     }</div><div id="55" class="line none">   55 </div><div id="56" class="line none">   56     // Deduct the payment amount from the source internal account</div><div id="57" class="line hit">   57     for (int i = 0; i &lt; NUMTOKENS; i++) {</div><div id="58" class="line hit">   58         if (sourceAccount-&gt;wallet.tokens[i].currency == candidateTransaction-&gt;currency) {</div><div id="59" class="line hit">   59             sourceAccount-&gt;wallet.tokens[i].amount -= candidateTransaction-&gt;amount;</div><div id="60" class="line none">   60         }</div><div id="61" class="line hit">   61     }</div><div id="62" class="line none">   62 </div><div id="63" class="line none">   63     // Credit the payment amount to the destination external wallet</div><div id="64" class="line hit">   64     for (int i = 0; i &lt; NUMTOKENS; i++) {</div><div id="65" class="line hit">   65         if (destinationParty-&gt;wallet.tokens[i].currency == candidateTransaction-&gt;currency) {</div><div id="66" class="line hit">   66             destinationParty-&gt;wallet.tokens[i].amount += candidateTransaction-&gt;amount;</div><div id="67" class="line none">   67         }</div><div id="68" class="line hit">   68     }</div><div id="69" class="line none">   69 </div><div id="70" class="line hit">   70     printf("Payment processed:\n");</div><div id="71" class="line hit">   71     printf("Source: %s (Internal Account ID: %d)\n", sourceParty-&gt;name, sourceAccount-&gt;id);</div><div id="72" class="line hit">   72     printf("Destination: %s (Wallet ID: %d)\n", destinationParty-&gt;name, destinationParty-&gt;id);</div><div id="73" class="line hit">   73     printf("Amount: %d\n", candidateTransaction-&gt;amount);</div><div id="74" class="line hit">   74     printf("Currency: %s\n", <a href="getters.c.html#7">getCurrencyTypeName</a>(candidateTransaction-&gt;currency));</div><div id="75" class="line none">   75 </div><div id="76" class="line none">   76     // Move the contract state to the continueAs contract</div><div id="77" class="line hit">   77     state-&gt;currentContract = state-&gt;currentContract-&gt;continueAs;</div><div id="78" class="line hit">   78     return 0;</div><div id="79" class="line hit">   79 }</div>
</div>
</body>
</html>
