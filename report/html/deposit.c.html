
<html>
<head>
<title>deposit.c</title>
<link rel="stylesheet" type="text/css" href="./viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 #include &lt;stdio.h&gt;</div><div id="2" class="line none">    2 #include &lt;stdlib.h&gt;</div><div id="3" class="line none">    3 #include &lt;string.h&gt;</div><div id="4" class="line none">    4 #include &lt;assert.h&gt;</div><div id="5" class="line none">    5 #include "../include/constants.h"</div><div id="6" class="line none">    6 #include "../include/types.h"</div><div id="7" class="line none">    7 #include "../include/getters.h"</div><div id="8" class="line none">    8 </div><div id="9" class="line none">    9 int <a href="deposit.c.html#9">makeDeposit</a>(ContractState* state, const Transaction* candidateTransaction, const DepositParameters* depositPayload) {</div><div id="10" class="line none">   10     // Retrieve the source and destination parties</div><div id="11" class="line hit">   11     Party* sourceParty = candidateTransaction-&gt;source;</div><div id="12" class="line hit">   12     Party* destinationParty = candidateTransaction-&gt;destination;</div><div id="13" class="line none">   13 </div><div id="14" class="line none">   14     // Check if the source and destination parties exist</div><div id="15" class="line hit">   15     if (sourceParty == NULL || destinationParty == NULL) {</div><div id="16" class="line missed">   16         printf("Invalid transaction! Source or destination party not found.\n");</div><div id="17" class="line missed">   17         return 1;</div><div id="18" class="line none">   18     }</div><div id="19" class="line none">   19 </div><div id="20" class="line none">   20     // Retrieve the destination internal account</div><div id="21" class="line hit">   21     InternalAccount* destinationAccount = NULL;</div><div id="22" class="line hit">   22     for (int i = 0; i &lt; state-&gt;internalWallet.numAccounts; i++) {</div><div id="23" class="line none">   23         // printf("DEBUG: Internal ID %d for Party ID %d\n", state-&gt;internalWallet.accounts[i].id, destinationParty-&gt;id);</div><div id="24" class="line hit">   24         if (state-&gt;internalWallet.accounts[i].id == destinationParty-&gt;id) {</div><div id="25" class="line hit">   25             destinationAccount = &amp;(state-&gt;internalWallet.accounts[i]);</div><div id="26" class="line none">   26         }</div><div id="27" class="line hit">   27     }</div><div id="28" class="line none">   28 </div><div id="29" class="line none">   29     // Check if the destination internal account exists</div><div id="30" class="line hit">   30     if (destinationAccount == NULL) {</div><div id="31" class="line missed">   31         printf("Invalid transaction! Destination internal account not found.\n");</div><div id="32" class="line missed">   32         return 1;</div><div id="33" class="line none">   33     }</div><div id="34" class="line none">   34 </div><div id="35" class="line none">   35     // Check if there are enough funds in the source external wallet</div><div id="36" class="line hit">   36     int sourceBalance = 0;</div><div id="37" class="line none">   37     // __CPROVER_assume(sourceParty-&gt;wallet.numTokens == 2);</div><div id="38" class="line hit">   38     for (int i = 0; i &lt; NUMTOKENS; i++) {</div><div id="39" class="line hit">   39         if (sourceParty-&gt;wallet.tokens[i].currency == candidateTransaction-&gt;currency) {</div><div id="40" class="line hit">   40             sourceBalance = sourceParty-&gt;wallet.tokens[i].amount;</div><div id="41" class="line none">   41         }</div><div id="42" class="line hit">   42     }</div><div id="43" class="line none">   43 </div><div id="44" class="line hit">   44     if (sourceBalance &lt; candidateTransaction-&gt;amount) {</div><div id="45" class="line hit">   45         printf("Insufficient funds in the source external wallet.\n");</div><div id="46" class="line hit">   46         return 1;</div><div id="47" class="line none">   47     }</div><div id="48" class="line none">   48 </div><div id="49" class="line none">   49     // Check if the candidate transaction matches the deposit payload</div><div id="50" class="line hit">   50     if (candidateTransaction-&gt;source == depositPayload-&gt;depositor &amp;&amp;</div><div id="51" class="line none">   51         candidateTransaction-&gt;destination == depositPayload-&gt;receiver &amp;&amp;</div><div id="52" class="line none">   52         candidateTransaction-&gt;amount == depositPayload-&gt;amount &amp;&amp;</div><div id="53" class="line none">   53         candidateTransaction-&gt;currency == depositPayload-&gt;currency) {</div><div id="54" class="line none">   54 </div><div id="55" class="line none">   55         // Credit the payment amount to the destination internal account</div><div id="56" class="line hit">   56         if (destinationAccount-&gt;wallet.tokens[0].currency == candidateTransaction-&gt;currency) {</div><div id="57" class="line hit">   57             destinationAccount-&gt;wallet.tokens[0].amount += candidateTransaction-&gt;amount;</div><div id="58" class="line none">   58         }</div><div id="59" class="line hit">   59         if (destinationAccount-&gt;wallet.tokens[1].currency == candidateTransaction-&gt;currency) {</div><div id="60" class="line hit">   60             destinationAccount-&gt;wallet.tokens[1].amount += candidateTransaction-&gt;amount;</div><div id="61" class="line none">   61         }</div><div id="62" class="line none">   62 </div><div id="63" class="line none">   63         // Deduct the payment amount from the source external wallet</div><div id="64" class="line none">   64         // __CPROVER_assume(sourceParty-&gt;wallet.numTokens == 2);</div><div id="65" class="line hit">   65         printf("DEBUG: NumTokens is %d\n", NUMTOKENS);</div><div id="66" class="line hit">   66         if (sourceParty-&gt;wallet.tokens[0].currency == candidateTransaction-&gt;currency) {</div><div id="67" class="line hit">   67             sourceParty-&gt;wallet.tokens[0].amount -= candidateTransaction-&gt;amount;</div><div id="68" class="line none">   68         }</div><div id="69" class="line hit">   69         if (sourceParty-&gt;wallet.tokens[1].currency == candidateTransaction-&gt;currency) {</div><div id="70" class="line hit">   70             sourceParty-&gt;wallet.tokens[1].amount -= candidateTransaction-&gt;amount;</div><div id="71" class="line none">   71         }</div><div id="72" class="line none">   72 </div><div id="73" class="line hit">   73         printf("Deposit processed:\n");</div><div id="74" class="line hit">   74         printf("Source: %s (Wallet ID: %d)\n", candidateTransaction-&gt;source-&gt;name, sourceParty-&gt;id);</div><div id="75" class="line hit">   75         printf("Destination: %s (Internal Account ID: %d)\n", candidateTransaction-&gt;destination-&gt;name, destinationAccount-&gt;id);</div><div id="76" class="line hit">   76         printf("Amount: %d\n", candidateTransaction-&gt;amount);</div><div id="77" class="line hit">   77         printf("Currency: %s\n", <a href="getters.c.html#7">getCurrencyTypeName</a>(candidateTransaction-&gt;currency));</div><div id="78" class="line none">   78 </div><div id="79" class="line none">   79         // Move the contract to the subContractOK pointer</div><div id="80" class="line hit">   80         state-&gt;currentContract = state-&gt;currentContract-&gt;subContractOK;</div><div id="81" class="line both">   81         return 0; // Deposit successful</div><div id="82" class="line none">   82     } else {</div><div id="83" class="line missed">   83         printf("Invalid transaction! Deposit failed.\n");</div><div id="84" class="line none">   84 </div><div id="85" class="line none">   85         // Move the contract to the continueAs pointer</div><div id="86" class="line none">   86         // TODO: Remove this when the timeout is added, as it's not the correct semantics</div><div id="87" class="line missed">   87         state-&gt;currentContract = state-&gt;currentContract-&gt;continueAs;</div><div id="88" class="line missed">   88         return 1; // Deposit failed</div><div id="89" class="line none">   89     }</div><div id="90" class="line both">   90 }</div>
</div>
</body>
</html>
