
<html>
<head>
<title>close.c</title>
<link rel="stylesheet" type="text/css" href="./viewer.css">
</head>

<body>
<div class="code">
<div id="1" class="line none">    1 #include &lt;stdio.h&gt;</div><div id="2" class="line none">    2 #include &lt;stdlib.h&gt;</div><div id="3" class="line none">    3 #include &lt;string.h&gt;</div><div id="4" class="line none">    4 #include &lt;assert.h&gt;</div><div id="5" class="line none">    5 #include "../include/constants.h"</div><div id="6" class="line none">    6 #include "../include/types.h"</div><div id="7" class="line none">    7 </div><div id="8" class="line none">    8 void <a href="close.c.html#8">processClose</a>(ContractState* state) {</div><div id="9" class="line none">    9     // Iterate over each internal account</div><div id="10" class="line hit">   10     printf("Closing contract...\n");</div><div id="11" class="line hit">   11     for (int i = 0; i &lt; state-&gt;internalWallet.numAccounts; i++) {</div><div id="12" class="line hit">   12         InternalAccount* account = &amp;(state-&gt;internalWallet.accounts[i]);</div><div id="13" class="line none">   13 </div><div id="14" class="line none">   14         // Find the corresponding party for the internal account</div><div id="15" class="line hit">   15         Party* externalParty = NULL;</div><div id="16" class="line hit">   16         for (int j = 0; j &lt; state-&gt;numParties; j++) {</div><div id="17" class="line hit">   17             if (state-&gt;parties[j]-&gt;id == account-&gt;id) {</div><div id="18" class="line hit">   18                 externalParty = state-&gt;parties[j];</div><div id="19" class="line hit">   19                 break;</div><div id="20" class="line none">   20             }</div><div id="21" class="line hit">   21         }</div><div id="22" class="line none">   22 </div><div id="23" class="line none">   23         // Refund the tokens from the internal account to the external wallet</div><div id="24" class="line none">   24         // printf("Processing close for party %d\n", account-&gt;id);</div><div id="25" class="line hit">   25         for (int j = 0; j &lt; account-&gt;wallet.numTokens; j++) {</div><div id="26" class="line hit">   26             Token* token = &amp;(account-&gt;wallet.tokens[j]);</div><div id="27" class="line hit">   27             for (int k = 0; k &lt; externalParty-&gt;wallet.numTokens; k++) {</div><div id="28" class="line hit">   28                 if (externalParty-&gt;wallet.tokens[k].currency == token-&gt;currency) {</div><div id="29" class="line none">   29                     // printf("Refunding %d %s tokens to party %d\n", token-&gt;amount, token-&gt;currency, externalParty-&gt;id);</div><div id="30" class="line hit">   30                     externalParty-&gt;wallet.tokens[k].amount += token-&gt;amount;</div><div id="31" class="line hit">   31                     break;</div><div id="32" class="line none">   32                 }</div><div id="33" class="line hit">   33             }</div><div id="34" class="line hit">   34         }</div><div id="35" class="line none">   35 </div><div id="36" class="line none">   36         // Clear the internal account</div><div id="37" class="line hit">   37         for (int j = 0; j &lt; account-&gt;wallet.numTokens; j++) {</div><div id="38" class="line hit">   38             account-&gt;wallet.tokens[j].amount = 0;</div><div id="39" class="line hit">   39         }</div><div id="40" class="line hit">   40     }</div><div id="41" class="line hit">   41 }</div>
</div>
</body>
</html>
